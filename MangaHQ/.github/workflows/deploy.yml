name: Deploy to GitHub Pages

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    permissions:
      contents: read
      pages: write
      id-token: write

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Validate Firebase Configuration
      run: |
        echo "üîç Validando configura√ß√£o do Firebase..."
        
        # Verificar se os arquivos essenciais existem
        if [ ! -f "js/firebase-config-secure.js" ]; then
          echo "‚ùå Arquivo firebase-config-secure.js n√£o encontrado"
          exit 1
        fi
        
        if [ ! -f "firestore.rules" ]; then
          echo "‚ùå Arquivo firestore.rules n√£o encontrado"
          exit 1
        fi
        
        if [ ! -f "index.html" ]; then
          echo "‚ùå Arquivo index.html n√£o encontrado"
          exit 1
        fi
        
        echo "‚úÖ Todos os arquivos essenciais encontrados"

    - name: Check Security Configuration
      run: |
        echo "üîí Verificando configura√ß√£o de seguran√ßa..."
        
        # Verificar se a configura√ß√£o segura est√° sendo usada
        if grep -q "firebase-config-secure.js" index.html; then
          echo "‚úÖ Configura√ß√£o segura detectada no index.html"
        else
          echo "‚ö†Ô∏è  Aviso: Configura√ß√£o segura n√£o detectada"
        fi
        
        # Verificar se h√° valida√ß√£o de dom√≠nio
        if grep -q "isAuthorizedDomain" index.html; then
          echo "‚úÖ Valida√ß√£o de dom√≠nio implementada"
        else
          echo "‚ö†Ô∏è  Aviso: Valida√ß√£o de dom√≠nio n√£o encontrada"
        fi

    - name: Setup Pages
      uses: actions/configure-pages@v3

    - name: Upload artifact
      uses: actions/upload-pages-artifact@v2
      with:
        path: '.'

    - name: Deploy to GitHub Pages
      id: deployment
      uses: actions/deploy-pages@v2

    - name: Post-deployment Security Check
      run: |
        echo "üöÄ Deploy conclu√≠do!"
        echo ""
        echo "üîß LEMBRETE: Configure no Firebase Console:"
        echo "1. Authentication > Settings > Authorized domains"
        echo "2. Adicione: ${GITHUB_REPOSITORY_OWNER}.github.io"
        echo "3. Firestore Database > Rules (aplique firestore.rules)"
        echo ""
        echo "üåê Site dispon√≠vel em: https://${GITHUB_REPOSITORY_OWNER}.github.io/${GITHUB_REPOSITORY#*/}"
